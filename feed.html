<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Gallery - Dawn & Dusk</title>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            -webkit-text-size-adjust: 100%;
        }

        :root {
            --color-bg: #c0c0c0;
            --color-surface: #ffffff;
            --color-text: #000000;
            --color-text-muted: #555555;
            --color-border: #999999;
            --font-serif: 'Times New Roman', Times, Georgia, serif;
            --font-sans: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --font-mono: 'Courier New', 'Monaco', monospace;
        }

        body {
            font-family: var(--font-sans);
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
            min-height: 100vh;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 2px solid var(--color-border);
            background: var(--color-surface);
            box-shadow: inset 0 -1px 0 rgba(255,255,255,0.5);
        }

        .brand {
            font-family: var(--font-serif);
            font-size: 2.25rem;
            font-weight: bold;
            letter-spacing: -0.02em;
            color: var(--color-text);
            text-decoration: none;
        }

        .brand:visited { color: var(--color-text); }

        .brand span {
            color: var(--color-text-muted);
            font-size: 1rem;
            margin-left: 8px;
            font-weight: normal;
        }

        .nav-link {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            padding: 10px 16px;
            border: 2px outset var(--color-border);
            background: #f0f0f0;
            color: var(--color-text);
            text-decoration: none;
            cursor: pointer;
        }

        .nav-link:hover { background: #cccccc; }
        .nav-link:active { border-style: inset; background: #bbbbbb; }

        .page-title {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: bold;
            padding: 20px 24px 12px;
            background: #e0e0e0;
            border-bottom: 2px outset var(--color-border);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            padding: 24px;
        }

        .photo-card {
            background: var(--color-surface);
            border: 2px outset var(--color-border);
            overflow: hidden;
        }

        .photo-card img {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            display: block;
            border-bottom: 1px solid var(--color-border);
        }

        .photo-meta {
            padding: 10px 12px;
            font-size: 0.8125rem;
        }

        .photo-location {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .photo-date {
            color: var(--color-text-muted);
            font-family: var(--font-mono);
            font-size: 0.75rem;
        }

        .load-more {
            display: block;
            margin: 0 auto 32px;
            padding: 12px 32px;
            font-family: var(--font-mono);
            font-size: 0.875rem;
            font-weight: 500;
            border: 2px outset var(--color-border);
            background: #f0f0f0;
            color: var(--color-text);
            cursor: pointer;
        }

        .load-more:hover { background: #cccccc; }
        .load-more:active { border-style: inset; background: #bbbbbb; }
        .load-more:disabled { opacity: 0.5; cursor: default; }

        .empty-state {
            text-align: center;
            padding: 64px 24px;
            color: var(--color-text-muted);
            font-size: 1rem;
        }

        .loading {
            text-align: center;
            padding: 48px 24px;
            font-family: var(--font-mono);
            color: var(--color-text-muted);
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .lightbox.open {
            display: flex;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border: 2px outset var(--color-border);
        }

        @media (max-width: 600px) {
            .header { flex-wrap: wrap; gap: 12px; padding: 12px 16px; }
            .brand { font-size: 1.5rem; }
            .brand span { display: none; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); padding: 16px; gap: 12px; }
            .page-title { padding: 16px; font-size: 1.25rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="brand">Dawn & Dusk <span>Community Gallery</span></a>
        <a href="/" class="nav-link">Back to Map</a>
    </header>

    <div class="page-title">Community Sunset & Sunrise Photos</div>

    <div id="loading" class="loading">Loading photos...</div>
    <div id="gallery" class="gallery-grid" style="display:none;"></div>
    <div id="empty" class="empty-state" style="display:none;">No photos yet. Be the first to share a sunset from the app!</div>
    <button id="loadMore" class="load-more" style="display:none;" onclick="loadMore()">Load More</button>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <img id="lightboxImg" src="" alt="Full size photo">
    </div>

    <script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
    <script>
        // Configure CloudKit
        CloudKit.configure({
            containers: [{
                containerIdentifier: 'iCloud.lucaspfeiffer.sun',
                apiTokenAuth: {
                    // Replace with your actual CloudKit JS API token from the dashboard
                    apiToken: 'd7c16e30d342fe4205cf13d047ea9e28dadead0db04ed24f62035604a77d6d4f',
                    persist: false
                },
                environment: 'production'
            }]
        });

        const PAGE_SIZE = 20;
        let continuationMarker = null;
        let allPhotos = [];

        async function fetchPhotos(cursor) {
            const container = CloudKit.getDefaultContainer();
            await container.setUpAuth();
            const db = container.publicCloudDatabase;

            const query = {
                recordType: 'SunPhoto',
                filterBy: [{
                    fieldName: 'status',
                    comparator: 'EQUALS',
                    fieldValue: { value: 'approved' }
                }],
                sortBy: [{
                    fieldName: 'captureDate',
                    ascending: false
                }]
            };

            const options = {
                resultsLimit: PAGE_SIZE
            };

            if (cursor) {
                options.continuationMarker = cursor;
            }

            const response = await db.performQuery(query, options);

            if (response.hasErrors) {
                console.error('CloudKit query error:', response.errors);
                return { records: [], hasMore: false };
            }

            continuationMarker = response.continuationMarker || null;

            return {
                records: response.records || [],
                hasMore: !!continuationMarker
            };
        }

        function renderPhoto(record) {
            const fields = record.fields;
            const thumbnailURL = fields.thumbnail ? fields.thumbnail.value.downloadURL : '';
            const imageURL = fields.image ? fields.image.value.downloadURL : '';
            const locationName = fields.locationName ? fields.locationName.value : 'Unknown';
            const captureDate = fields.captureDate ? new Date(fields.captureDate.value) : new Date();

            const dateStr = captureDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            const card = document.createElement('div');
            card.className = 'photo-card';
            card.innerHTML = `
                <img src="${thumbnailURL}" alt="Sunset photo from ${locationName}" loading="lazy"
                     onclick="openLightbox('${imageURL}')" style="cursor:pointer;">
                <div class="photo-meta">
                    <div class="photo-location">${locationName}</div>
                    <div class="photo-date">${dateStr}</div>
                </div>
            `;
            return card;
        }

        async function loadPhotos() {
            try {
                const { records, hasMore } = await fetchPhotos(null);
                const gallery = document.getElementById('gallery');
                const loading = document.getElementById('loading');
                const empty = document.getElementById('empty');
                const loadMoreBtn = document.getElementById('loadMore');

                loading.style.display = 'none';

                if (records.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                gallery.style.display = 'grid';
                records.forEach(record => {
                    gallery.appendChild(renderPhoto(record));
                });

                if (hasMore) {
                    loadMoreBtn.style.display = 'block';
                }
            } catch (err) {
                console.error('Failed to load photos:', err);
                document.getElementById('loading').textContent = 'Failed to load photos. Please try again later.';
            }
        }

        async function loadMore() {
            const btn = document.getElementById('loadMore');
            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                const { records, hasMore } = await fetchPhotos(continuationMarker);
                const gallery = document.getElementById('gallery');

                records.forEach(record => {
                    gallery.appendChild(renderPhoto(record));
                });

                if (!hasMore) {
                    btn.style.display = 'none';
                } else {
                    btn.disabled = false;
                    btn.textContent = 'Load More';
                }
            } catch (err) {
                console.error('Failed to load more:', err);
                btn.disabled = false;
                btn.textContent = 'Load More';
            }
        }

        function openLightbox(url) {
            if (!url) return;
            document.getElementById('lightboxImg').src = url;
            document.getElementById('lightbox').classList.add('open');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('open');
            document.getElementById('lightboxImg').src = '';
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadPhotos();
            } catch (err) {
                console.error('Init error:', err);
                document.getElementById('loading').textContent = 'Failed to load photos. Please try again later.';
            }
        });
    </script>
</body>
</html>
